#include "Registry.h"

////////////////////////////////////////////////////////////////////////////////////////////////
// Create a registry key
////////////////////////////////////////////////////////////////////////////////////////////////
void CRegistry::CreateKey(HKEY MainKey, LPCTSTR SubKey)
{
	HKEY hKey = NULL;
	DWORD Disposition = 0;

	RegCreateKeyEx(MainKey, SubKey, 0L, NULL, REG_OPTION_NON_VOLATILE, KEY_ALL_ACCESS, NULL, &hKey, &Disposition);
	CloseKey(hKey);
}

////////////////////////////////////////////////////////////////////////////////////////////////
// Delete a registry key
////////////////////////////////////////////////////////////////////////////////////////////////
void CRegistry::DeleteKey(HKEY MainKey, LPCTSTR SubKey)
{
	RegDeleteKey(MainKey, SubKey);
}

////////////////////////////////////////////////////////////////////////////////////////////////
// Tell if a registry key exist
////////////////////////////////////////////////////////////////////////////////////////////////
bool CRegistry::DoesKeyExist(HKEY MainKey, LPCTSTR SubKey)
{
	HKEY hKey = NULL;
	bool Res = false;
	if(this->OpenKey(MainKey, SubKey, &hKey)){
		this->CloseKey(hKey);
		Res = true;
	}

	return Res;
}

////////////////////////////////////////////////////////////////////////////////////////////////
// Get a registry value
////////////////////////////////////////////////////////////////////////////////////////////////
bool CRegistry::GetValue(HKEY MainKey, LPCTSTR SubKey, LPCTSTR Value, DWORD Type, BYTE *pBuffer, DWORD *pBufferSize)
{
	HKEY hKey = NULL;
	bool Res = false;
	if(this->OpenKey(MainKey, SubKey, &hKey)){
		Res = RegQueryValueEx(hKey, Value, 0L, &Type, pBuffer, pBufferSize) == ERROR_SUCCESS;
		this->CloseKey(hKey);
	}
	return Res;
}

////////////////////////////////////////////////////////////////////////////////////////////////
// Get a registry value
////////////////////////////////////////////////////////////////////////////////////////////////
UINT CRegistry::GetValueType(HKEY MainKey, LPCTSTR SubKey, LPCTSTR Value)
{
	HKEY hKey = NULL;
	DWORD Type = 0, BufferSize = 0;
	if(this->OpenKey(MainKey, SubKey, &hKey)){
		RegQueryValueEx(hKey, Value, 0L, &Type, NULL, &BufferSize);
		this->CloseKey(hKey);
	}
	return Type;
}

////////////////////////////////////////////////////////////////////////////////////////////////
// Set a registry value
////////////////////////////////////////////////////////////////////////////////////////////////
void CRegistry::SetValue(HKEY MainKey, LPCTSTR SubKey, LPCTSTR Value, DWORD Type, BYTE *pBuffer, DWORD BufferSize)
{
	HKEY hKey = NULL;
	if(this->OpenKey(MainKey, SubKey, &hKey)){
		RegSetValueEx(hKey, Value, 0L, Type, pBuffer, BufferSize);
		this->CloseKey(hKey);
	}
}

////////////////////////////////////////////////////////////////////////////////////////////////
// Delete a registry value
////////////////////////////////////////////////////////////////////////////////////////////////
void CRegistry::DeleteValue(HKEY MainKey, LPCTSTR SubKey, LPCTSTR Value)
{
	HKEY hKey = NULL;
	if(this->OpenKey(MainKey, SubKey, &hKey)){
		RegDeleteValue(hKey, Value);
		this->CloseKey(hKey);
	}
}

bool CRegistry::DoesValueExist(HKEY MainKey, LPCTSTR SubKey, LPCTSTR Value)
{
	HKEY hKey = NULL;
	DWORD Type = 0, BufferSize = 0;
	bool Res = false;
	if(this->OpenKey(MainKey, SubKey, &hKey)){
		Res = RegQueryValueEx(hKey, Value, 0L, &Type, NULL, &BufferSize) != ERROR_FILE_NOT_FOUND;
		this->CloseKey(hKey);
	}
	return Res;
}

////////////////////////////////////////////////////////////////////////////////////////////////
// Open a registry key (internal only)
////////////////////////////////////////////////////////////////////////////////////////////////
bool CRegistry::OpenKey(HKEY MainKey, LPCTSTR SubKey, PHKEY phKey)
{
	return RegOpenKeyEx(MainKey, SubKey, 0L, KEY_ALL_ACCESS, phKey) == ERROR_SUCCESS;
}

////////////////////////////////////////////////////////////////////////////////////////////////
// Close a registry key (internal only)
////////////////////////////////////////////////////////////////////////////////////////////////
void CRegistry::CloseKey(HKEY hKey)
{
	if(hKey)
		RegCloseKey(hKey);
}


